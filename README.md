### ðŸ¤– `robot-agent` (æœºå™¨äººå®¢æˆ·ç«¯)

è¿™ä¸ªé¡¹ç›®æ˜¯è¿è¡Œåœ¨ **ESP32-S3** åµŒå…¥å¼è®¾å¤‡ä¸Šçš„ **MicroPython** åº”ç”¨ç¨‹åºã€‚å®ƒç›´æŽ¥æŽ§åˆ¶æœºå™¨äººçš„ç¡¬ä»¶ï¼Œå¹¶ä½œä¸ºç”¨æˆ·ä¸ŽæœåŠ¡å™¨ä¹‹é—´çš„æ¡¥æ¢ã€‚

**æ ¸å¿ƒåŠŸèƒ½:**

1.  **ç¡¬ä»¶é©±åŠ¨**:
    *   **å±å¹•**: ä½¿ç”¨ `LVGL` å›¾å½¢åº“é©±åŠ¨ä¸€å—å½©è‰²å±å¹•ï¼Œå¯ä»¥æ˜¾ç¤ºæœºå™¨äººçš„å„ç§çŠ¶æ€å’ŒåŠ¨ç”»ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ `image_state_display.py` å®žçŽ°çš„çœ¨çœ¼ã€å“­æ³£ã€æƒŠè®¶ç­‰è¡¨æƒ…ï¼‰ã€‚
    *   **éº¦å…‹é£Ž**: é€šè¿‡ `microphone.py` æ•èŽ·ç”¨æˆ·çš„å£°éŸ³ã€‚
    *   **æ‰¬å£°å™¨**: é€šè¿‡ `speaker.py` æ’­æ”¾å£°éŸ³ã€‚
    *   **ç‰©ç†æŒ‰é”®**: ä½œä¸ºç”¨æˆ·å‘èµ·å¯¹è¯çš„è§¦å‘å™¨ã€‚

2.  **æ ¸å¿ƒå·¥ä½œæµç¨‹**:
    *   **å¾…æœº**: ç¨‹åºå¯åŠ¨åŽï¼Œè®¾å¤‡è¿›å…¥å¾…æœºçŠ¶æ€ï¼Œå±å¹•ä¸Šå¯èƒ½ä¼šæ˜¾ç¤ºå¾…æœºåŠ¨ç”»ï¼ˆå¦‚çœ¨çœ¼ï¼‰ã€‚
    *   **å½•éŸ³ä¸Žä¸Šä¼ **: å½“ç”¨æˆ·æŒ‰ä¸‹ç‰©ç†æŒ‰é”®æ—¶ï¼Œè®¾å¤‡ä¼šç«‹å³å¼€å§‹é€šè¿‡éº¦å…‹é£Žå½•éŸ³ï¼Œå¹¶é€šè¿‡ `WebSocket` è¿žæŽ¥ï¼Œå°†éŸ³é¢‘æ•°æ®å®žæ—¶åœ°ã€æµå¼åœ°ä¼ è¾“åˆ° `robot-agent-server`ã€‚
    *   **æŽ¥æ”¶ä¸Žå“åº”**: å½•éŸ³ç»“æŸåŽï¼Œå®ƒä¼šç­‰å¾…æœåŠ¡å™¨çš„å›žåº”ã€‚æœåŠ¡å™¨ä¼šå°†ç”Ÿæˆçš„è¯­éŸ³æµå¼ä¼ è¾“å›žæ¥ï¼Œ`robot-agent` æŽ¥æ”¶åˆ°è¿™äº›éŸ³é¢‘æ•°æ®åŽï¼Œç«‹å³é€šè¿‡æ‰¬å£°å™¨æ’­æ”¾å‡ºæ¥ã€‚
    *   **è¿œç¨‹å·¥å…·æ‰§è¡Œ**: å®ƒè‡ªèº«å®šä¹‰äº†ä¸€äº›å¯ä»¥åœ¨æœ¬åœ°æ‰§è¡Œçš„â€œå·¥å…·â€ï¼ˆå®šä¹‰åœ¨ `tools.py` ä¸­ï¼‰ã€‚æœåŠ¡å™¨å¯ä»¥å‘é€ä¸€ä¸ª JSON æŒ‡ä»¤ï¼Œè¦æ±‚è®¾å¤‡æ‰§è¡ŒæŸä¸ªå·¥å…·ï¼ˆæ¯”å¦‚è°ƒæ•´å±å¹•äº®åº¦ã€æ’­æ”¾ç‰¹å®šåŠ¨ç”»ç­‰ï¼‰ï¼Œè®¾å¤‡æ‰§è¡ŒåŽä¼šå°†ç»“æžœè¿”å›žç»™æœåŠ¡å™¨ã€‚

**å°ç»“**: `robot-agent` æœ¬èº«ä¸å…·å¤‡æ™ºèƒ½ï¼Œå®ƒæ˜¯ä¸€ä¸ªçº¯ç²¹çš„â€œæ„ŸçŸ¥å’Œæ‰§è¡Œâ€ç«¯ï¼Œè´Ÿè´£æ”¶é›†ç”¨æˆ·çš„å£°éŸ³å¹¶å¿ å®žåœ°æ‰§è¡Œæ¥è‡ªæœåŠ¡å™¨çš„æŒ‡ä»¤ã€‚

---

### ðŸ§  `robot-agent-server` (äº‘ç«¯å¤§è„‘)

è¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºŽ `asyncio` çš„é«˜æ€§èƒ½ Python æœåŠ¡å™¨ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ™ºèƒ½æ ¸å¿ƒã€‚å®ƒè´Ÿè´£å¤„ç†æ‰€æœ‰å¤æ‚çš„è®¡ç®—ä»»åŠ¡ã€‚

**æ ¸å¿ƒåŠŸèƒ½:**

1.  **è¿žæŽ¥ç®¡ç†**:
    *   é€šè¿‡ `websocket_server.py` ç›‘å¬å¹¶ç®¡ç†æ¥è‡ª `robot-agent` å®¢æˆ·ç«¯çš„ `WebSocket` è¿žæŽ¥ã€‚
    *   å½“è®¾å¤‡è¿žæŽ¥æ—¶ï¼Œé€šè¿‡ `message_handler.py` ä¸­çš„æ³¨å†Œæµç¨‹ï¼Œè®°å½•è®¾å¤‡çš„ MAC åœ°å€å’Œå®ƒæ‰€æ”¯æŒçš„â€œå·¥å…·â€åˆ—è¡¨ï¼Œå¹¶å°†è®¾å¤‡ä¿¡æ¯å­˜å…¥æ•°æ®åº“(`database_manager.py`)ã€‚

2.  **æ ¸å¿ƒå·¥ä½œæµç¨‹**:
    *   **è¯­éŸ³è½¬æ–‡å­— (ASR)**: æŽ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„éŸ³é¢‘æµåŽï¼Œä½¿ç”¨ `fun_asr_local.py` ä¸­çš„è¯­éŸ³è¯†åˆ«å¼•æ“Žï¼Œå°†å®Œæ•´çš„éŸ³é¢‘æ•°æ®è½¬æ¢æˆæ–‡å­—ã€‚
    *   **AI å¤§è„‘å¤„ç†**: å°†è¯†åˆ«å‡ºçš„æ–‡å­—ï¼Œè¿žåŒå®¢æˆ·ç«¯çš„åŽ†å²å¯¹è¯è®°å½•ï¼Œä¸€èµ·å‘é€ç»™ä¸€ä¸ªå¤§åž‹è¯­è¨€æ¨¡åž‹ (LLM) è¿›è¡Œå¤„ç†ï¼ˆä»Žä»£ç ç»“æž„ `agent_graph` å’Œ `gemini_key` ï¼Œä½¿ç”¨äº† Google Gemini æ¨¡åž‹ï¼‰ã€‚
    *   **å†³ç­–ä¸Žå·¥å…·è°ƒç”¨**: AI å¤§è„‘æ ¹æ®ç”¨æˆ·çš„è¾“å…¥è¿›è¡Œå†³ç­–ã€‚å¦‚æžœç”¨æˆ·çš„æ„å›¾æ˜¯è°ƒç”¨ä¸€ä¸ªè®¾å¤‡ç«¯çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚â€œæŠŠå±å¹•è°ƒäº®â€ï¼‰ï¼ŒAIä¼šç”Ÿæˆä¸€ä¸ªè°ƒç”¨å·¥å…·çš„æŒ‡ä»¤ï¼ŒæœåŠ¡å™¨å†å°†è¯¥æŒ‡ä»¤é€šè¿‡ WebSocket å‘é€ç»™ `robot-agent` æ‰§è¡Œã€‚
    *   **æ–‡å­—è½¬è¯­éŸ³ (TTS)**: AI å¤§è„‘ç”Ÿæˆå›žå¤æ–‡æœ¬åŽï¼Œ`tts_processor.py` ä¼šè°ƒç”¨ TTS å¼•æ“Žï¼Œå°†è¿™æ®µæ–‡å­—å®žæ—¶è½¬æ¢æˆè¯­éŸ³æµã€‚
    *   **æµå¼å“åº”**: æœ€å…³é”®çš„ä¸€æ­¥ï¼ŒæœåŠ¡å™¨ä¸ä¼šç­‰æ‰€æœ‰è¯­éŸ³éƒ½ç”Ÿæˆå®Œæ¯•å†å‘é€ï¼Œè€Œæ˜¯è¾¹ç”Ÿæˆè¾¹é€šè¿‡ `WebSocket` å°†è¯­éŸ³æ•°æ®å—æµå¼åœ°ä¼ å›žç»™ `robot-agent`ï¼Œæžå¤§åœ°é™ä½Žäº†ç”¨æˆ·å¬è§å›žå¤çš„å»¶è¿Ÿã€‚

**å°ç»“**: `robot-agent-server` æ˜¯æœºå™¨äººçš„â€œå¤§è„‘â€ï¼Œå®ƒå®Œæˆäº†ä»Žâ€œå¬æ‡‚â€ï¼ˆASRï¼‰åˆ°â€œæ€è€ƒâ€ï¼ˆLLMï¼‰ï¼Œå†åˆ°â€œè¯´è¯â€ï¼ˆTTSï¼‰çš„æ•´ä¸ªè®¤çŸ¥è¿‡ç¨‹ã€‚

---

### äº¤äº’æµç¨‹å›¾

ä¸ºäº†æ›´ç›´è§‚åœ°å±•ç¤ºå®ƒä»¬çš„åä½œæ–¹å¼ï¼Œæˆ‘ä¸ºä½ åˆ›å»ºäº†ä¸€ä¸ªäº¤äº’æµç¨‹å›¾ï¼š

```Mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Agent as robot-agent (è®¾å¤‡ç«¯)
    participant Server as robot-agent-server (äº‘ç«¯)
    participant ASR as è¯­éŸ³è¯†åˆ«æœåŠ¡
    participant LLM as AIå¤§è¯­è¨€æ¨¡åž‹
    participant TTS as è¯­éŸ³åˆæˆæœåŠ¡

    User->>Agent: æŒ‰ä¸‹ç‰©ç†æŒ‰é”®
    Agent->>Server: å»ºç«‹WebSocketè¿žæŽ¥å¹¶æ³¨å†Œ
    Server-->>Agent: æ³¨å†ŒæˆåŠŸ

    activate Agent
    User->>Agent: å¼€å§‹è¯´è¯
    Agent->>Server: [æµå¼ä¼ è¾“] å®žæ—¶éº¦å…‹é£ŽéŸ³é¢‘
    User->>Agent: ç»“æŸè¯´è¯
    Agent->>Server: [æµå¼ä¼ è¾“] å‘é€éŸ³é¢‘ç»“æŸä¿¡å·
    deactivate Agent

    activate Server
    Server->>ASR: å‘é€å®Œæ•´éŸ³é¢‘æ•°æ®
    ASR-->>Server: è¿”å›žè¯†åˆ«åŽçš„æ–‡æœ¬

    Server->>LLM: å‘é€æ–‡æœ¬å’ŒåŽ†å²å¯¹è¯
    LLM-->>Server: [æµå¼è¿”å›ž] AIç”Ÿæˆçš„å›žå¤æ–‡æœ¬

    Server->>TTS: [æµå¼å¤„ç†] å°†æ–‡æœ¬åˆ†å¥å¹¶åˆæˆè¯­éŸ³
    TTS-->>Server: [æµå¼è¿”å›ž] åˆæˆçš„è¯­éŸ³æµ

    Server->>Agent: [æµå¼ä¼ è¾“] å°†è¯­éŸ³æµå®žæ—¶å‘å›žè®¾å¤‡
    deactivate Server

    activate Agent
    Agent->>User: å®žæ—¶æ’­æ”¾æ”¶åˆ°çš„è¯­éŸ³
    deactivate Agent
```